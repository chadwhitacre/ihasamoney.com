from aspen import Response
from ihazmoney import db, get_tags


months = ["", "Jan", "Feb","Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep",
        "Oct", "Nov", "Dec"]

def commaize(amount):
    """Given a 2-decimal number as a string, return it with commas.
    """
    if len(amount) <= 6:
        return amount
    whole, fraction = amount.split('.')
    whole = list(whole)
    out = '.' + fraction
    i = 1 
    while whole:
        out = whole.pop() + out
        if i % 3 == 0:
            out = ',' + out
        i += 1
    return out.lstrip(',')

def gentxns(txns):
    curdate = 0000, 00, 00
    for row in txns:

        d = row['date']
        year, month, day = d.year, d.month, d.day
        if (year, month, day) == curdate:
            date = "&nbsp;"
        elif (year, month) == curdate[:2]:
            date = "%02d" % day
        elif (year,) == curdate[:1]:
            date = "%s %02d" % (months[month], day)
        else:
            date = "%04d %s %02d" % (year, months[month], day)
        curdate = (year, month, day)

        amount = commaize(str(abs(row['amount'])))
        if row['amount'] < 0:
            amount = "<i>%s</i>" % amount

        tags = row['tags']
        if tags is None:
            tags = []
        yield row['id'], amount, row['description'], date, tags

def gentags(tags):
    i = 0
    N = len(tags)
    for tag in tags:
        i += 1
        yield ( tag
              , i % 4 == 0  # is_a (as in asdf)
              , i == 0      # is_first
              , i == N-1    # is_last
               )

# ========================================================================== ^L

if request.user.ANON:
    raise Response(401)

email = request.user.session['email']

tags = get_tags(email)
txns = db.fetchall("""

    SELECT id
         , email
         , date
         , amount
         , description
         , (  SELECT tags.tag
                FROM tags
                JOIN taggings
                  ON taggings.tag_id = tags.id
               WHERE taggings.transaction_id = transactions.id
            ) as tags
      FROM transactions 
     WHERE email=%s 
  ORDER BY date DESC
  
    """, (email,))


# ========================================================================== ^L
<!DOCTYPE html>
<html>
    <head>
        <title>I Haz Money!</title>
        <script src="/assets/jquery-1.7.1.min.js"></script>
        <script src="/assets/jquery.mousewheel.js"></script>
        <style>@import url("/assets/ihazmoney.css");</style>
        <script src="/assets/ihazmoney.js"></script>
        <script>
            $(document).ready(IHazMoney.main);
        </script>
        {% block head %}{% end %}
    </head>
    <body>
        <div id="body">

            <div id="top">
                {% if "signing_in" in globals() %}
                You are signing in.
                {% elif request.user.ANON %}       
                You are not signed in. <a href="/sign/in.html">Sign in</a>.
                {% else %}
                Signed in as <b>{{ request.user.session['email'] }}</b>. 
                <a href="/sign/out.html">Sign out</a>.
                {% end %}

                <table id="tags">
                    <tr><td><input id="new-tag" /><button>Add Tag</button></td></tr>
                    {% for tag in tags %}
                    <tr><td>{{ tag }}</td></tr>
                    {% end %}
                </table>
            </div>

            <div id="middle">
                <table>
                    {% for tid, amount, description, date, ttags in gentxns(txns) %}
                    <tr class="focus" tid="{{ tid }}">
                        <td class="date">{{ date }}</td>
                        <td class="amount">{{ amount }}</td>
                        {% for tag, is_a, is_first, is_last in gentags(tags) %}
                        <td class="tag{% if is_a %} a{% end %}{% if is_first %} first{% end %}{% if is_last %} last{% end %}{% if tag in ttags %} tagged{% end %}" 
                            tag="{{ tag }}"></td>
                        {% end %}
                        <td class="description">{{ description }}</td>
                    </tr>
                    {% end %}
                </table>
            </div>
            
            <div id="bottom"></div>

        </div>{% if website.gauges %}
        <script type="text/javascript">
          var _gauges = _gauges || [];
          (function() {
            var t   = document.createElement('script');
            t.type  = 'text/javascript';
            t.async = true;
            t.id    = 'gauges-tracker';
            t.setAttribute('data-site-id', '4ee664fe613f5d7f24000001');
            t.src = '//secure.gaug.es/track.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(t, s);
          })();
        </script>{% end %}
    </body>
</html>
