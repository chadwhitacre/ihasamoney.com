import decimal

from aspen import Response
from ihazmoney import db, get_tags


months = ["", "Jan", "Feb","Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep",
        "Oct", "Nov", "Dec"]

def commaize(amount):
    """Given a 2-decimal number as a string, return it with commas.
    """
    if isinstance(amount, decimal.Decimal):
        amount = "%.02f" % amount
    if decimal.Decimal(amount) == 0:
        return "0" + ("&nbsp;" * 3)
    if amount.startswith('-'):
        amount = amount[1:] # abs
    if len(amount) <= 6:
        return amount
    whole, fraction = amount.split('.')
    whole = list(whole)
    out = '.' + fraction
    i = 1 
    while whole:
        out = whole.pop() + out
        if i % 3 == 0:
            out = ',' + out
        i += 1
    return out.lstrip(',')

def gentxns(txns, max_amount):
    curdate = 0000, 00, 00
    for row in txns:

        # red hot, baby!
        d = row['date']
        year, month, day = d.year, d.month, d.day
        if (year, month, day) == curdate:
            date = ('<td class="year"><span class="hide">%04d</span></td>'
                    '<td class="month"><span class="hide">%s</span></td>'
                    '<td class="day"><span class="hide">%02d</span></td>')
        elif (year, month) == curdate[:2]:
            date = ('<td class="year"><span class="hide">%04d</span></td>'
                    '<td class="month"><span class="hide">%s</span></td>'
                    '<td class="day">%02d</td>')
        elif (year,) == curdate[:1]:
            date = ('<td class="year"><span class="hide">%04d</span></td>'
                    '<td class="month">%s</td>'
                    '<td class="day">%02d</td>')
        else:
            date = ('<td class="year">%04d</td>'
                    '<td class="month">%s</td>'
                    '<td class="day">%02d</td>')
        date %= (year, months[month], day)
        date = date.replace('>0', '>&nbsp;')
        date = date.replace(' 0', '&nbsp;&nbsp;')
        curdate = (year, month, day)

        amount = commaize(str(abs(row['amount'])))
        amount = ((len(max_amount) - len(amount)) * "&nbsp;") + amount
        if row['amount'] < 0:
            amount = "<i>%s</i>" % amount

        tag = row['tag'] # This comes out as a single string or None, not
                         # (e.g.) list of strings, if there is only one tag. 
                         # And our UI assures that there is only one tag.

        if tag is None:
            tag = "uncategorized"

        yield row['id'], amount, row['description'], date, tag

# ========================================================================== ^L

if request.user.ANON:
    raise Response(401)

email = request.user.session['email']

balance = commaize(request.user.session['balance'])


tags = get_tags(email)
txns = db.fetchall("""

    SELECT id
         , email
         , date
         , amount
         , description
         , (  SELECT tags.tag
                FROM tags
                JOIN taggings
                  ON taggings.tag_id = tags.id
               WHERE taggings.transaction_id = transactions.id
            ) as tag -- a single tag, it turns out
      FROM transactions 
     WHERE email=%s 
  ORDER BY date DESC
  
    """, (email,))

row = db.fetchone("""
    
    SELECT max(amount) AS max_amount
      FROM transactions
     WHERE email = %s

        """, (email,))
max_amount = commaize(row['max_amount'])

sums = db.fetchall("""
    
    SELECT tags.tag                 AS tag
         , sum(transactions.amount) AS sum
      FROM transactions 
      JOIN taggings 
        ON taggings.transaction_id = transactions.id 
      JOIN tags 
        ON tags.id = taggings.tag_id 
     WHERE transactions.email = %s
  GROUP BY tag
  ORDER BY tag

        """, (email,))

summary = dict([(tag, decimal.Decimal(0)) for tag in tags])
for row in sums:
    summary[row['tag']] = row['sum']

# ========================================================================== ^L
<!DOCTYPE html>
<html>
    <head>
        <title>ihazmoney</title>
        <script src="/assets/jquery-1.7.1.min.js"></script>
        <script src="/assets/jquery.mousewheel.js"></script>
        <style>@import url("/assets/ihazmoney.css");</style>
        <script src="/assets/ihazmoney.js"></script>
        <script>
            $(document).ready(IHazMoney.main);
        </script>
        {% block head %}{% end %}
    </head>
    <body>
        <div id="body">

            <div id="top">
                <div id="sign">
                    {% if "signing_in" in globals() %}
                    You are signing in.
                    {% elif request.user.ANON %}       
                    You are not signed in. <a href="/sign/in.html">Sign in</a>.
                    {% else %}
                    {{ request.user.session['email'] }} -
                    <a href="/sign/out.html">sign out</a>
                    {% end %}
                </div>
                <div id="balance">${{ balance }}</div>
            </div>

            <!--
                <span class="widget"><input 
                /><button>create</button></span><span 
                class="knob">create a tag</span>
            -->

            <table>
                <thead class="pegged">
                    <tr>
                        <th colspan="4" class="corner"></th>
                        {% for tag in tags %}<th>{{ tag  }}</th>{% end %}
                    </tr>
                </thead>
                <thead class="unpegged">
                    <tr>
                        <th colspan="4" class="corner"></th>
                        {% for tag in tags %}<th>{{ tag  }}</th>{% end %}
                    </tr>
                </thead>
                <tbody>
                    {% for tid, amount, desc, date, tag in gentxns(txns, max_amount) %}
                    <tr tid="{{ tid }}" tag="{{ tag }}">
                        {{ date }}
                        <td class="description">{{ desc }}</td>
                        {% for _tag in tags %}<td 
                            class="amount{% if _tag == tag %} tagged{% end %}"
                            tag="{{ _tag }}">
                            {% if _tag == tag %}{{ amount }}{% end %}</td>
                        {% end %}
                    </tr>
                    {% end %}
                </tbody>
            </table>

        </div>{% if website.gauges %}
        <script type="text/javascript">
          var _gauges = _gauges || [];
          (function() {
            var t   = document.createElement('script');
            t.type  = 'text/javascript';
            t.async = true;
            t.id    = 'gauges-tracker';
            t.setAttribute('data-site-id', '4ee664fe613f5d7f24000001');
            t.src = '//secure.gaug.es/track.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(t, s);
          })();
        </script>{% end %}
    </body>
</html>
